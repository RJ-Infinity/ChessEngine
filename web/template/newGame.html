{% extends "base.html" %}
{%block title%}New Game{%endblock%}
{%block head%}
	<script src="static/ChessBoard.min.js"></script>
	<style>
		chess-board-{
			display: block;
			position: sticky;
			top: 1em;
			aspect-ratio: 1 / 1;
		}
		main{
			display: grid;
			grid-template-columns: 2fr 1fr;
			gap: 1em;
			height: max-content;
			width: 100%;
			box-sizing: border-box;
		}
		@media screen and (max-width:650px) {
			body{
				height: 100%;
			}
			main{
				grid-template-columns: 1fr;
				height: 100%;
				min-height: 0;
			}
			chess-board-{
				position: relative;
				top: auto;
			}
			.settings{
				min-height: 0;
				overflow: auto;
			}
		}
		.setting::before{
			content: attr(name);
			grid-column: 1 / span 2;
		}
		.setting{
			display: grid;
			height: min-content;
			width: 100%;
			margin-bottom: 2em;
		}
		.board-size{
			grid-template-columns: 1fr 10ch;
		}
		.disabled-sqr{
			grid-template-columns: max-content 1fr;
		}
	</style>
{%endblock%}
{%block main%}
	<chess-board- id="ChessBoard"></chess-board->
	<div class="settings">
		<div class="setting board-size" name="Board Size">
			<input type="range" min="3" max="30" value="8" id="chessBoardWidthSlider">
			<input type="number" min="1" value="8" id="chessBoardWidth">
		</div>
		<div class="setting disabled-sqr" name="Disabled Squares">
			<input type="checkbox" id="disablePieces">
			<input type="text" id="disabledPieces">
			<button id="removeBtn">Toggle selected pieces</button>
		</div>
	</div>
	<script>
		var chessBoard = document.getElementById("ChessBoard");

		
		var chessBoardWidthSlider = document.getElementById("chessBoardWidthSlider");
		var chessBoardWidth = document.getElementById("chessBoardWidth");

		chessBoardWidthSlider.value = 8;
		chessBoardWidth.value = 8;

		const chessBoardWidthInput = e=>{
			chessBoardWidth.value = e.target.value;
			chessBoardWidthSlider.value = e.target.value;
			chessBoard.setAttribute("size",e.target.value);
			chessBoard.refreshBoard();
		}
		chessBoardWidthSlider.addEventListener("input",chessBoardWidthInput);
		chessBoardWidth.addEventListener("input",chessBoardWidthInput);



		var disabledPieces = document.getElementById("disabledPieces");
		var disablePieces = document.getElementById("disablePieces");
		var removeBtn = document.getElementById("removeBtn");

		disabledPieces.value = "";
		disablePieces.checked = false;
		var chessDisabledPieces = []
		
		disabledPieces.addEventListener("input",e => {
			chessDisabledPieces = e.target.value.split(" ").filter(el=>el!=="");
			highlightDisabledPieces();
		});
		const highlightDisabledPieces = ()=>{
			disabledPieces.parentNode.classList.remove("error");
			for (let i = 0; i < chessBoard.size; i++) {
				for (let j = 0; j < chessBoard.size; j++) {
					chessBoard.highlightPiece(chessBoard.toCoord({x:i,y:j}),"red",true);
				}
			}
			chessDisabledPieces.forEach(el => {
				try{
					if (!chessBoard.disabled.includes(chessBoard.toIndex(el))){
						chessBoard.highlightPiece(el,"red")
					}
				}catch (error){
					disabledPieces.parentElement.classList.add("error")
				}
			});
			chessBoard.disabled.forEach(el => {
				if (!chessDisabledPieces.includes(chessBoard.toCoord(el))){
					try{
						chessBoard.highlightPiece(chessBoard.toCoord(el),"red")
					}catch (error){
						disabledPieces.parentElement.classList.add("error")
					}
				}
			})
		}
		chessBoard.addEventListener("chessrefreshed",highlightDisabledPieces);
		chessBoard.addEventListener("chessclick",e=>{
			if(disablePieces.checked){
				if (chessDisabledPieces.includes(e.detail.pos)){
					disabledPieces.value = chessDisabledPieces.filter(el=>e.detail.pos!==el).join(" ");
				}else{
					disabledPieces.value = [...chessDisabledPieces, e.detail.pos].join(" ");
				}
				chessDisabledPieces = disabledPieces.value.split(" ").filter(el=>el!=="")
				highlightDisabledPieces();
			}
		})
		removeBtn.addEventListener("click",e=>{
			if (!disabledPieces.parentElement.classList.contains("error")){
				chessBoard.setAttribute("disabled",disabledPieces.value);
				chessBoard.refreshBoard();
			}
		});
		
	</script>
{%endblock%}